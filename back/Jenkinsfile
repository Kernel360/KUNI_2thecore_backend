pipeline {
  agent any

  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(daysToKeepStr: '14', numToKeepStr: '20',
                              artifactDaysToKeepStr: '7', artifactNumToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
  }

  environment {
    DEPLOY_HOST = '43.203.110.104'
    PEM_PATH    = '/var/lib/jenkins/.ssh/kernel-2thecore.pem'
    BUNDLE_DIR  = 'deploy'
  }

  stages {
    stage('Checkout') {
      steps {
        timestamps {
          checkout([$class: 'GitSCM',
            userRemoteConfigs: [[url: 'https://github.com/Kernel360/KUNI_2thecore_backend.git']],
            branches: [[name: '*/dev']]
          ])
        }
      }
    }

    stage('Prepare known_hosts') {
      steps {
        timestamps {
          sh '''
            set -e
            mkdir -p ~/.ssh && chmod 700 ~/.ssh
            ssh-keygen -R ${DEPLOY_HOST} || true
            ssh-keyscan -H ${DEPLOY_HOST} >> ~/.ssh/known_hosts 2>/dev/null
            chmod 600 ~/.ssh/known_hosts
          '''
        }
      }
    }

    stage('Build JARs (main, hub)') {
      steps {
        timestamps {
          sh '''
            set -euo pipefail
            cd back
            chmod +x gradlew

            ./gradlew --no-daemon --max-workers=1 -Dorg.gradle.jvmargs="-Xms256m -Xmx1024m" \
              :main-server:bootJar -x test

            ./gradlew --no-daemon --max-workers=1 -Dorg.gradle.jvmargs="-Xms256m -Xmx1024m" \
              :hub-server:bootJar -x test
          '''
        }
      }
    }

    stage('Assemble deploy bundle') {
      steps {
        timestamps {
          withCredentials([file(credentialsId: '2thecore-env', variable: 'ENV_FILE')]) {
            sh '''
              set -euo pipefail

              rm -rf ${BUNDLE_DIR}
              mkdir -p ${BUNDLE_DIR}/release/main-server
              mkdir -p ${BUNDLE_DIR}/release/hub-server

              cp $(ls -t back/main-server/build/libs/*SNAPSHOT.jar | head -n1) ${BUNDLE_DIR}/release/main-server/app.jar
              cp $(ls -t back/hub-server/build/libs/*SNAPSHOT.jar   | head -n1) ${BUNDLE_DIR}/release/hub-server/app.jar

              cp back/main-server/Dockerfile ${BUNDLE_DIR}/Dockerfile.main
              cp back/hub-server/Dockerfile  ${BUNDLE_DIR}/Dockerfile.hub
              cp back/docker/docker-compose.yml ${BUNDLE_DIR}/docker-compose.yml

              install -D -m 600 -T "$ENV_FILE" ${BUNDLE_DIR}/prod.env

              tar -czf backend-bundle.tar -C ${BUNDLE_DIR} .
              echo "[OK] backend-bundle.tar 생성"
            '''
          }
        }
      }
    }

    stage('Deploy to EC2 via SSH') {
      steps {
        timestamps {
          sh '''
            scp -o StrictHostKeyChecking=no -i ${PEM_PATH} backend-bundle.tar ubuntu@${DEPLOY_HOST}:~

            ssh -o StrictHostKeyChecking=no -i ${PEM_PATH} ubuntu@${DEPLOY_HOST} 'bash -lc "
              set -euo pipefail
              rm -rf ~/backend-deploy && mkdir -p ~/backend-deploy
              tar -xzf ~/backend-bundle.tar -C ~/backend-deploy

              cd ~/backend-deploy

              docker rm -f 2thecore-redis 2thecore-rabbitmq 2thecore-hub 2thecore-main 2>/dev/null || true
              docker network rm backend-deploy_rabbitmq_net 2>/dev/null || true
              docker compose down --remove-orphans 2>/dev/null || true

              docker compose --env-file ./prod.env up -d --build

              rm -f ~/backend-bundle.tar || true
            "'
          '''
        }
      }
    }
  }

  post {
    always {
      timestamps {
        sh '''
          set -e
          rm -f backend-bundle.tar || true
          rm -rf ${BUNDLE_DIR} || true
        '''
        echo "Pipeline finished."
      }
    }
  }
}
