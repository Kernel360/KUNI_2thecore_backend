pipeline {
  agent any

  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(daysToKeepStr: '14', numToKeepStr: '20',
                              artifactDaysToKeepStr: '7', artifactNumToKeepStr: '10'))
    timeout(time: 30, unit: 'MINUTES')
  }

  environment {
    DEPLOY_HOST = '43.203.110.104'
    BUNDLE_DIR  = 'deploy'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          userRemoteConfigs: [[url: 'https://github.com/Kernel360/KUNI_2thecore_backend.git']],
          branches: [[name: '*/websocket']]
        ])
      }
    }

    stage('Prepare known_hosts') {
      steps {
        sh '''
          set -e
          mkdir -p ~/.ssh && chmod 700 ~/.ssh
          ssh-keygen -R ${DEPLOY_HOST} || true
          ssh-keyscan -H ${DEPLOY_HOST} >> ~/.ssh/known_hosts 2>/dev/null
          chmod 600 ~/.ssh/known_hosts
        '''
      }
    }

    stage('Build JARs (main, hub)') {
      steps {
        sh '''#!/bin/bash
        set -e
        cd back
        chmod +x gradlew

        ./gradlew --no-daemon --max-workers=1 -Dorg.gradle.jvmargs="-Xms256m -Xmx1024m" \
          :main-server:bootJar -x test

        ./gradlew --no-daemon --max-workers=1 -Dorg.gradle.jvmargs="-Xms256m -Xmx1024m" \
          :hub-server:bootJar -x test
        '''
      }
    }

    stage('Assemble deploy bundle') {
      steps {
        withCredentials([file(credentialsId: '2thecore-env', variable: 'ENV_FILE')]) {
          sh '''#!/bin/bash
            set -e

            rm -rf ${BUNDLE_DIR}
            mkdir -p ${BUNDLE_DIR}

            BUILD_TIMESTAMP=$(date +%s)

            # JAR 파일을 번들 루트에 배치
            cp back/main-server/build/libs/main-server-0.0.1-SNAPSHOT.jar ${BUNDLE_DIR}/app.main.${BUILD_TIMESTAMP}.jar
            cp back/hub-server/build/libs/hub-server-0.0.1-SNAPSHOT.jar   ${BUNDLE_DIR}/app.hub.${BUILD_TIMESTAMP}.jar

            # Dockerfile 복사 (Dockerfile 내용도 JAR 파일 이름에 맞춰 수정해야 함!)
            cp back/main-server/Dockerfile ${BUNDLE_DIR}/Dockerfile.main
            cp back/hub-server/Dockerfile  ${BUNDLE_DIR}/Dockerfile.hub

            # docker-compose.yml
            cp back/docker/docker-compose.yml ${BUNDLE_DIR}/docker-compose.yml

            # prod.env
            install -D -m 600 -T "$ENV_FILE" ${BUNDLE_DIR}/prod.env

            tar -czf backend-bundle.tar -C ${BUNDLE_DIR} .
            echo "[OK] backend-bundle.tar 생성"
            '''
        }
      }
    }

    stage('Deploy to EC2 via SSH') {
        steps {
            sshagent(credentials: ['2thecore-ec2']) {
                sh """
                    scp -o StrictHostKeyChecking=no backend-bundle.tar ubuntu@43.203.110.104:~
                    ssh -o StrictHostKeyChecking=no ubuntu@43.203.110.104 bash -lc "
                        set -e
                        rm -rf ~/backend-deploy && mkdir -p ~/backend-deploy
                        tar -xzf ~/backend-bundle.tar -C ~/backend-deploy
                        cd ~/backend-deploy

                        docker rm -f 2thecore-redis 2thecore-rabbitmq 2thecore-hub 2thecore-main 2>/dev/null || true
                        docker network rm backend-deploy_rabbitmq_net 2>/dev/null || true
                        docker compose down --remove-orphans 2>/dev/null || true

                        # ${env.BUILD_TIMESTAMP}가 Jenkins에 의해 값으로 치환된 후 원격 서버로 전달됩니다.
                        docker compose build --no-cache \
                                         --build-arg JAR_NAME=app.main.${env.BUILD_TIMESTAMP}.jar main-server \
                                         --build-arg JAR_NAME=app.hub.${env.BUILD_TIMESTAMP}.jar hub-server

                        docker compose --env-file ./prod.env up -d --remove-orphans

                        rm -f ~/backend-bundle.tar || true
                    "
                """
            }
        }
    }
  }

  post {
    always {
      sh '''
        set -e
        rm -f backend-bundle.tar || true
        rm -rf ${BUNDLE_DIR} || true
      '''
      echo "Pipeline finished."
    }
  }
}
