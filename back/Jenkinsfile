pipeline {
  agent any
  options { timestamps() }

  environment {
    IMAGE_NAME = '2thecore-server'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          userRemoteConfigs: [[url: 'https://github.com/Kernel360/KUNI_2thecore_backend.git']],
          branches: [[name: '*/dev-Jenkins-test']]
        ])
      }
    }

    stage('Build') {
      steps {
        withCredentials([file(credentialsId: '2thecore-env', variable: 'ENV_FILE')]) {
          sh '''
            set -euo pipefail
            ./gradlew clean bootJar -x test
            tar --exclude='./build' --exclude='./.gradle' -czvf backend-project.tar .
          '''
        }
      }
    }

    stage('Deploy to EC2 via SSH') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-token', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_TOKEN')]) {
          script {
            def DEPLOY_HOST = "ec2-43-203-191-246.ap-northeast-2.compute.amazonaws.com"
            def PEM_PATH = '~/Downloads/kernel-2thecore-ec2.pem'
            sh """
              scp -i ${PEM_PATH} backend-project.tar ubuntu@${DEPLOY_HOST}:~
              ssh -i ${PEM_PATH} ubuntu@${DEPLOY_HOST} << EOF
                tar -xzvf backend-project.tar
                mv -i ./prod.env ./docker/prod.env
                cd docker
                docker compose --env-file ./prod.env up -d --build
              EOF
            """
          }
        }
      }
    }
  }

  post {
    always {
      echo "Pipeline finished."
    }
  }
}